name: ë¼ì´íŠ¸í•˜ìš°ìŠ¤ CI

on:
  push:
    branches:
      - main
      - develop
      - feature/**
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  pull_request:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'

env:
  NODE_VERSION: '18'

jobs:
  lighthouse:
    name: ${{ matrix.app }} ë¼ì´íŠ¸í•˜ìš°ìŠ¤ CI ì‹¤í–‰
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app: [admin, student]

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: yarn install --frozen-lockfile

      - name: í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        run: |
          echo "TEST_ID=${{ secrets.TEST_ID }}" >> $GITHUB_ENV
          echo "TEST_PW=${{ secrets.TEST_PW }}" >> $GITHUB_ENV

      - name: ${{ matrix.app }} ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
        run: yarn workspace @mozu/${{ matrix.app }} build

      - name: ${{ matrix.app }} ë¼ì´íŠ¸í•˜ìš°ìŠ¤ CI ì‹¤í–‰
        run: npx lhci autorun --config=./.lighthouserc.json
        working-directory: ./packages/${{ matrix.app }}

      - name: ${{ matrix.app }} ë¼ì´íŠ¸í•˜ìš°ìŠ¤ ê²°ê³¼ PR ëŒ“ê¸€ ì¶”ê°€
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const appName = process.env.APP_NAME;
            const reportsDir = `./packages/${appName}/lhci_reports`;
            
            try {
              if (!fs.existsSync(reportsDir)) {
                console.log(`${appName}ì— ëŒ€í•œ ë¼ì´íŠ¸í•˜ìš°ìŠ¤ ë¦¬í¬íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                return;
              }
              
              const files = fs.readdirSync(reportsDir);
              console.log(`ë°œê²¬ëœ íŒŒì¼ë“¤: ${files.join(', ')}`);
              
              // manifest.json íŒŒì¼ ì°¾ê¸° (LHCI ìš”ì•½ íŒŒì¼)
              const manifestFile = files.find(f => f === 'manifest.json');
              
              if (manifestFile) {
                // manifest.json ì‚¬ìš© (LHCI ìš”ì•½ ë°ì´í„°)
                const manifestPath = path.join(reportsDir, manifestFile);
                const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));
                console.log(`ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ì—ì„œ ${manifest.length}ê°œì˜ ë¦¬í¬íŠ¸ ë°œê²¬`);
                
                // representative run (ëŒ€í‘œ ì‹¤í–‰) ë°ì´í„°ë§Œ í•„í„°ë§í•˜ê±°ë‚˜, ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ë°ì´í„° ì‚¬ìš©
                const representativeReports = manifest.filter(report => report.isRepresentativeRun);
                const reportsToUse = representativeReports.length > 0 ? representativeReports : manifest.slice(0, 6);
                
                // ê° ì¹´í…Œê³ ë¦¬ë³„ í‰ê·  ì ìˆ˜ ê³„ì‚°
                const avgScores = {
                  performance: 0,
                  accessibility: 0,
                  'best-practices': 0,
                  seo: 0
                };
                
                reportsToUse.forEach(report => {
                  if (report.summary) {
                    avgScores.performance += report.summary.performance || 0;
                    avgScores.accessibility += report.summary.accessibility || 0;
                    avgScores['best-practices'] += report.summary['best-practices'] || 0;
                    avgScores.seo += report.summary.seo || 0;
                  }
                });
                
                const reportCount = reportsToUse.length;
                const scores = {
                  performance: Math.round((avgScores.performance / reportCount) * 100),
                  accessibility: Math.round((avgScores.accessibility / reportCount) * 100),
                  'best-practices': Math.round((avgScores['best-practices'] / reportCount) * 100),
                  seo: Math.round((avgScores.seo / reportCount) * 100)
                };
                
                console.log(`${reportCount}ê°œ ë¦¬í¬íŠ¸ì˜ í‰ê·  ì ìˆ˜:`, scores);
                
              } else {
                // ê°œë³„ JSON ë¦¬í¬íŠ¸ íŒŒì¼ë“¤ ì°¾ê¸° (fallback)
                const reportFiles = files.filter(f => f.endsWith('.json') && f !== 'manifest.json');
                
                if (reportFiles.length === 0) {
                  console.log(`${appName}ì— ëŒ€í•œ JSON ë¦¬í¬íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                  return;
                }
                
                console.log(`ê°œë³„ ë¦¬í¬íŠ¸ íŒŒì¼ë“¤: ${reportFiles.join(', ')}`);
                
                const reportPath = path.join(reportsDir, reportFiles[0]);
                const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
                
                if (!report.categories) {
                  console.log('ë¦¬í¬íŠ¸ì— categoriesê°€ ì—†ìŠµë‹ˆë‹¤. ì „ì²´ êµ¬ì¡°:', Object.keys(report));
                  return;
                }
                
                const getScore = (category) => {
                  const cat = report.categories[category];
                  if (!cat || typeof cat.score !== 'number') {
                    console.log(`${category} ì¹´í…Œê³ ë¦¬ê°€ ì—†ê±°ë‚˜ ì ìˆ˜ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
                    return 0;
                  }
                  return Math.round(cat.score * 100);
                };
                
                const scores = {
                  performance: getScore('performance'),
                  accessibility: getScore('accessibility'),
                  'best-practices': getScore('best-practices'),
                  seo: getScore('seo')
                };
                
                console.log('ê°œë³„ ë¦¬í¬íŠ¸ì—ì„œ ì¶”ì¶œëœ ì ìˆ˜ë“¤:', scores);
              }
              
              const getEmoji = (score) => {
                if (score >= 90) return 'ğŸŸ¢';
                if (score >= 50) return 'ğŸŸ¡';
                return 'ğŸ”´';
              };
              
              const comment = `## ğŸš¨ \`${appName}\` ë¼ì´íŠ¸í•˜ìš°ìŠ¤ CI ê²°ê³¼ (Lighthouse CI Results)
              
              | í•­ëª© (Category) | ì ìˆ˜ (Score) | ìƒíƒœ (Status) |
              |-----------------|--------------|---------------|
              | ì„±ëŠ¥ (Performance) | ${scores.performance} | ${getEmoji(scores.performance)} |
              | ì ‘ê·¼ì„± (Accessibility) | ${scores.accessibility} | ${getEmoji(scores.accessibility)} |
              | ëª¨ë²” ì‚¬ë¡€ (Best Practices) | ${scores['best-practices']} | ${getEmoji(scores['best-practices'])} |
              | SEO | ${scores.seo} | ${getEmoji(scores.seo)} |
              
              ğŸ“Š **ìƒì„¸ ë¦¬í¬íŠ¸ (Detailed Report)**: [ë¼ì´íŠ¸í•˜ìš°ìŠ¤ CI ê²°ê³¼ ë³´ê¸° (View Lighthouse CI Results)](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              
              ${scores.performance < 50 ? 'âš ï¸ **ì„±ëŠ¥ ê²½ê³  (Performance Warning)**: ì ìˆ˜ê°€ 50ì  ë¯¸ë§Œì…ë‹ˆë‹¤. ì„±ëŠ¥ ìµœì í™”ë¥¼ ê³ ë ¤í•´ì£¼ì„¸ìš”. (Score is below 50. Consider optimizing.)' : ''}
              ${scores.accessibility < 70 ? 'âš ï¸ **ì ‘ê·¼ì„± ê²½ê³  (Accessibility Warning)**: ì ìˆ˜ê°€ 70ì  ë¯¸ë§Œì…ë‹ˆë‹¤. ì ‘ê·¼ì„± ë¬¸ì œë¥¼ ê²€í† í•´ì£¼ì„¸ìš”. (Score is below 70. Please review accessibility issues.)' : ''}
              `;
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              
            } catch (error) {
              console.error('ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            }
        env:
          APP_NAME: ${{ matrix.app }}

      - name: ${{ matrix.app }} ë¼ì´íŠ¸í•˜ìš°ìŠ¤ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports-${{ matrix.app }}-${{ github.sha }}
          path: |
            ./packages/${{ matrix.app }}/lhci_reports/
            ./packages/${{ matrix.app }}/lighthouse-debug.log
            ./packages/${{ matrix.app }}/url-collection.json
          retention-days: 30