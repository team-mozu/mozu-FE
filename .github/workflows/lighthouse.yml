name: ë¼ì´íŠ¸í•˜ìš°ìŠ¤ CI

on:
  push:
    branches:
      - main
      - develop
      - feature/**
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  pull_request:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'

env:
  NODE_VERSION: '18'

jobs:
  lighthouse:
    name: ${{ matrix.app }} ë¼ì´íŠ¸í•˜ìš°ìŠ¤ CI ì‹¤í–‰
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app: [admin, student]

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: yarn install --frozen-lockfile

      - name: í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        run: |
          echo "TEST_ID=${{ secrets.TEST_ID }}" >> $GITHUB_ENV
          echo "TEST_PW=${{ secrets.TEST_PW }}" >> $GITHUB_ENV

      - name: ${{ matrix.app }} ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
        run: yarn workspace @mozu/${{ matrix.app }} build

      - name: ${{ matrix.app }} ë¼ì´íŠ¸í•˜ìš°ìŠ¤ CI ì‹¤í–‰
        run: npx lhci autorun --config=./.lighthouserc.json
        working-directory: ./packages/${{ matrix.app }}

      - name: ${{ matrix.app }} ë¼ì´íŠ¸í•˜ìš°ìŠ¤ ê²°ê³¼ PR ëŒ“ê¸€ ì¶”ê°€
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const appName = process.env.APP_NAME;
            const reportsDir = `./packages/${appName}/lhci_reports`;
            
            try {
              if (!fs.existsSync(reportsDir)) {
                console.log(`${appName}ì— ëŒ€í•œ ë¼ì´íŠ¸í•˜ìš°ìŠ¤ ë¦¬í¬íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                return;
              }
              
              const files = fs.readdirSync(reportsDir);
              const reportFiles = files.filter(f => f.endsWith('.json'));
              
              if (reportFiles.length === 0) {
                console.log(`${appName}ì— ëŒ€í•œ JSON ë¦¬í¬íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                return;
              }
              
              const reportPath = path.join(reportsDir, reportFiles[0]);
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              
              const scores = {
                performance: Math.round(report.categories.performance.score * 100),
                accessibility: Math.round(report.categories.accessibility.score * 100),
                'best-practices': Math.round(report.categories['best-practices'].score * 100),
                seo: Math.round(report.categories.seo.score * 100)
              };
              
              const getEmoji = (score) => {
                if (score >= 90) return 'ğŸŸ¢';
                if (score >= 50) return 'ğŸŸ¡';
                return 'ğŸ”´';
              };
              
              const comment = `## ğŸš¨ \`${appName}\` ë¼ì´íŠ¸í•˜ìš°ìŠ¤ CI ê²°ê³¼ (Lighthouse CI Results)
              
              | í•­ëª© (Category) | ì ìˆ˜ (Score) | ìƒíƒœ (Status) |
              |-----------------|--------------|---------------|
              | ì„±ëŠ¥ (Performance) | ${scores.performance} | ${getEmoji(scores.performance)} |
              | ì ‘ê·¼ì„± (Accessibility) | ${scores.accessibility} | ${getEmoji(scores.accessibility)} |
              | ëª¨ë²” ì‚¬ë¡€ (Best Practices) | ${scores['best-practices']} | ${getEmoji(scores['best-practices'])} |
              | SEO | ${scores.seo} | ${getEmoji(scores.seo)} |
              
              ğŸ“Š **ìƒì„¸ ë¦¬í¬íŠ¸ (Detailed Report)**: [ë¼ì´íŠ¸í•˜ìš°ìŠ¤ CI ê²°ê³¼ ë³´ê¸° (View Lighthouse CI Results)](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              
              ${scores.performance < 50 ? 'âš ï¸ **ì„±ëŠ¥ ê²½ê³  (Performance Warning)**: ì ìˆ˜ê°€ 50ì  ë¯¸ë§Œì…ë‹ˆë‹¤. ì„±ëŠ¥ ìµœì í™”ë¥¼ ê³ ë ¤í•´ì£¼ì„¸ìš”. (Score is below 50. Consider optimizing.)' : ''}
              ${scores.accessibility < 70 ? 'âš ï¸ **ì ‘ê·¼ì„± ê²½ê³  (Accessibility Warning)**: ì ìˆ˜ê°€ 70ì  ë¯¸ë§Œì…ë‹ˆë‹¤. ì ‘ê·¼ì„± ë¬¸ì œë¥¼ ê²€í† í•´ì£¼ì„¸ìš”. (Score is below 70. Please review accessibility issues.)' : ''}
              `;
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              
            } catch (error) {
              console.error('ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            }
        env:
          APP_NAME: ${{ matrix.app }}

      - name: ${{ matrix.app }} ë¼ì´íŠ¸í•˜ìš°ìŠ¤ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports-${{ matrix.app }}-${{ github.sha }}
          path: |
            ./packages/${{ matrix.app }}/lhci_reports/
            ./packages/${{ matrix.app }}/lighthouse-debug.log
            ./packages/${{ matrix.app }}/url-collection.json
          retention-days: 30